name: AI-Powered CI/CD Pipeline (NEW WAY)

# This shows the AI-POWERED approach - runs ONLY affected tests
# Benefits: Fast, cheap, intelligent

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '18'

jobs:
  # Job 1: AI Failure Prediction
  # Runs FIRST to predict if build will fail
  # Saves time by catching issues early
  predict-failure:
    name: ðŸ¤– AI Failure Prediction
    runs-on: ubuntu-latest
    outputs:
      prediction: ${{ steps.predict.outputs.prediction }}
      confidence: ${{ steps.predict.outputs.confidence }}
      should_run: ${{ steps.predict.outputs.should_run }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 50  # Need history for ML analysis
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, json
          coverage: none
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-dev
      
      - name: Run AI Failure Prediction
        id: predict
        run: |
          RESULT=$(php artisan ai:predict-failure --json)
          echo "prediction=$(echo $RESULT | jq -r '.prediction')" >> $GITHUB_OUTPUT
          echo "confidence=$(echo $RESULT | jq -r '.confidence')" >> $GITHUB_OUTPUT
          
          # Decide if we should continue
          PREDICTION=$(echo $RESULT | jq -r '.prediction')
          if [ "$PREDICTION" = "FAIL" ]; then
            echo "should_run=review-required" >> $GITHUB_OUTPUT
          else
            echo "should_run=yes" >> $GITHUB_OUTPUT
          fi
          
          # Display prediction
          echo "::notice::AI Prediction: $PREDICTION ($(echo $RESULT | jq -r '.confidence')% confidence)"
      
      - name: Comment prediction on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prediction = '${{ steps.predict.outputs.prediction }}';
            const confidence = '${{ steps.predict.outputs.confidence }}';
            
            const emoji = prediction === 'PASS' ? 'âœ…' : 'âš ï¸';
            const message = `## ${emoji} AI Build Prediction
            
            **Prediction:** ${prediction}
            **Confidence:** ${confidence}%
            
            ${prediction === 'FAIL' ? 'âš ï¸ AI predicts this build may fail. Consider reviewing changes before merging.' : 'âœ… AI predicts build will pass successfully.'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  # Job 2: AI Test Selection
  # Analyzes changes and selects only relevant tests
  select-tests:
    name: ðŸŽ¯ AI Test Selection
    runs-on: ubuntu-latest
    needs: predict-failure
    if: needs.predict-failure.outputs.should_run != 'skip'
    outputs:
      tests: ${{ steps.select.outputs.tests }}
      test_count: ${{ steps.select.outputs.test_count }}
      reduction: ${{ steps.select.outputs.reduction }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff analysis
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, json
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-dev
      
      - name: Run AI Test Selection
        id: select
        run: |
          RESULT=$(php artisan ai:select-tests --json)
          
          # Extract test list
          TESTS=$(echo $RESULT | jq -r '.tests | join(",")')
          COUNT=$(echo $RESULT | jq -r '.selected_tests')
          REDUCTION=$(echo $RESULT | jq -r '.reduction_percentage')
          
          echo "tests=$TESTS" >> $GITHUB_OUTPUT
          echo "test_count=$COUNT" >> $GITHUB_OUTPUT
          echo "reduction=$REDUCTION" >> $GITHUB_OUTPUT
          
          echo "::notice::Selected $COUNT tests ($REDUCTION% reduction)"
      
      - name: Upload test selection report
        uses: actions/upload-artifact@v4
        with:
          name: test-selection-report
          path: storage/ai/test-selection.json

  # Job 3: Smart Tests
  # Runs only the selected tests in parallel
  smart-tests:
    name: ðŸš€ Smart Test Execution
    runs-on: ubuntu-latest
    needs: [predict-failure, select-tests]
    if: needs.predict-failure.outputs.should_run == 'yes'
    
    strategy:
      fail-fast: false
      matrix:
        # Parallel execution - split tests into chunks
        chunk: [1, 2, 3]
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: testing
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:alpine
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, json, redis, pdo, pdo_mysql
          coverage: xdebug
      
      # Smart caching - cache Composer dependencies
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
      
      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist
      
      # Skip npm steps - no package.json in this project
      # - name: Setup Node.js
      # - name: Install NPM dependencies
      # - name: Build assets
      
      - name: Prepare Laravel Application
        env:
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password
        run: |
          cp .env.example .env
          php artisan key:generate
          php artisan config:clear
          php artisan cache:clear
      
      - name: Run Database Migrations
        env:
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password
        run: php artisan migrate --force
      
      - name: Run Selected Tests (Chunk ${{ matrix.chunk }})
        env:
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: password
        run: |
          # Get selected tests from previous job
          TESTS="${{ needs.select-tests.outputs.tests }}"
          
          if [ -z \"$TESTS\" ] || [ \"$TESTS\" = \"\" ]; then
            echo \"âš ï¸ No specific tests selected, running smoke tests only\"
            php artisan test --filter=\"test_user_creation\"
          else
            echo \"ðŸŽ¯ Running AI-selected tests: $TESTS\"
            # Convert test list to filter pattern
            FILTER=$(echo \"$TESTS\" | tr ',' '|')
            php artisan test --filter=\"$FILTER\"
          fi
      
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: matrix.chunk == 1
        with:
          name: coverage-report
          path: coverage/

  # Job 4: Code Quality Checks (runs in parallel)
  code-quality:
    name: ðŸ“Š Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: phpcs, phpstan, phpmd
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-dev
      
      - name: Run PHP CodeSniffer
        run: vendor/bin/phpcs --standard=PSR12 app/
        continue-on-error: true
      
      - name: Run PHPStan
        run: vendor/bin/phpstan analyse app/ --level=5
        continue-on-error: true
      
      - name: Run PHP Mess Detector
        run: vendor/bin/phpmd app/ text cleancode,codesize,controversial,design,naming,unusedcode
        continue-on-error: true

  # Job 5: Security Scan
  security:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist
      
      - name: Check for known security vulnerabilities
        run: |
          composer audit
          
      - name: Run security checks
        run: |
          # Check for common vulnerabilities
          php artisan route:list --json | jq '.[] | select(.middleware | contains(["auth"]) | not)'

  # Job 6: Performance Analysis
  performance:
    name: âš¡ Performance Check
    runs-on: ubuntu-latest
    needs: [select-tests, smart-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Analyze build time savings
        run: |
          echo "# Performance Metrics" > performance.md
          echo "" >> performance.md
          echo "Tests Selected: ${{ needs.select-tests.outputs.test_count }}" >> performance.md
          echo "Reduction: ${{ needs.select-tests.outputs.reduction }}%" >> performance.md
          echo "Estimated Time Saved: ~$(echo "scale=1; 15 * ${{ needs.select-tests.outputs.reduction }} / 100" | bc) minutes" >> performance.md
      
      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance.md

  # Job 7: AI Learning (post-build)
  # Records build outcome for model training
  ai-learning:
    name: ðŸ§  AI Model Learning
    runs-on: ubuntu-latest
    needs: [predict-failure, smart-tests]
    if: always()  # Run even if tests fail
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
      
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist --no-dev
      
      - name: Record build outcome for AI training
        run: |
          OUTCOME="${{ needs.smart-tests.result }}"
          php artisan ai:record-outcome \
            --prediction="${{ needs.predict-failure.outputs.prediction }}" \
            --actual="$OUTCOME" \
            --confidence="${{ needs.predict-failure.outputs.confidence }}" || echo "Command not yet available"
      
      - name: Update model if needed
        run: |
          # Retrain model every 50 builds
          BUILD_COUNT=$(cat storage/ai/build-count.txt || echo 0)
          BUILD_COUNT=$((BUILD_COUNT + 1))
          echo $BUILD_COUNT > storage/ai/build-count.txt
          
          if [ $((BUILD_COUNT % 50)) -eq 0 ]; then
            echo "Retraining AI model..."
            php artisan ai:retrain-model
          fi

  # Job 8: Deployment (only on success)
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [select-tests, smart-tests, code-quality, security]
    if: github.ref == 'refs/heads/main' && success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          # Add your deployment commands here
      
      - name: Notify success
        run: |
          echo "âœ… Deployment successful!"
          echo "AI-optimized pipeline reduced CI/CD time by ${{ needs.select-tests.outputs.reduction }}%"

  # Summary Job
  summary:
    name: ðŸ“ˆ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [predict-failure, select-tests, smart-tests]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ¤– AI-Optimized CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Prediction" >> $GITHUB_STEP_SUMMARY
          echo "- **Result**: ${{ needs.predict-failure.outputs.prediction }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Confidence**: ${{ needs.predict-failure.outputs.confidence }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Selection" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests Selected**: ${{ needs.select-tests.outputs.test_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reduction**: ${{ needs.select-tests.outputs.reduction }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ needs.smart-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "âš¡ **Time Saved**: ~$(echo "scale=1; 15 * ${{ needs.select-tests.outputs.reduction }} / 100" | bc) minutes" >> $GITHUB_STEP_SUMMARY
